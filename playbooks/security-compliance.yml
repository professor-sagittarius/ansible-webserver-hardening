# Re-apply (or check) security hardening roles only
#
# Use --check for drift detection without making changes:
#   ansible-playbook -i inventories/localhost.yml playbooks/security-compliance.yml --check --ask-vault-pass
#
# Use without --check to re-enforce compliance after manual changes:
#   ansible-playbook -i inventories/localhost.yml playbooks/security-compliance.yml --ask-vault-pass

- name: Security Compliance - DevSec Hardening
  hosts: all
  become: true

  vars:
    # OS hardening (devsec.hardening.os_hardening)
    sysctl_overwrite:
      net.ipv4.ip_forward: 1
      net.ipv6.conf.all.forwarding: 1
    os_auth_pw_max_age: -1
    os_auth_pw_min_age: 0
    os_auth_lockout_time: 120
    os_ctrlaltdel_disabled: true
    os_remove_additional_root_users: true
    os_security_auto_logout: 1800

    # SSH hardening (devsec.hardening.ssh_hardening)
    sftp_enabled: true
    ssh_server_ports: ['22']
    ssh_max_auth_retries: 3
    ssh_client_alive_interval: 300
    ssh_client_alive_count: 6
    ssh_server_password_login: "{{ ssh_password_authentication | default(false) }}"
    ssh_allow_groups: "sudo"

  roles:
    - role: devsec.hardening.os_hardening
    - role: devsec.hardening.ssh_hardening
