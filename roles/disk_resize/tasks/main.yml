- name: Install growpart (cloud-guest-utils)
  ansible.builtin.apt:
    name: cloud-guest-utils
    state: present
    update_cache: true
    cache_valid_time: 3600

- name: Grow partition to use all available space
  ansible.builtin.command:
    cmd: "growpart {{ disk_device }} {{ partition_number }}"
  register: growpart_result
  changed_when: "'CHANGED' in growpart_result.stdout"
  failed_when: growpart_result.rc != 0 and 'NOCHANGE' not in growpart_result.stdout

- name: Resize filesystem
  ansible.builtin.command:
    cmd: "resize2fs {{ disk_device }}{{ partition_number }}"
  register: resize_result
  changed_when: "'nothing to do' not in resize_result.stderr"
  failed_when: resize_result.rc != 0 and 'Nothing to do' not in resize_result.stderr
  when: growpart_result.changed
  notify: reboot system
