# Install Docker using geerlingguy.docker role
- name: Install Docker
  ansible.builtin.include_role:
    name: geerlingguy.docker

# Configure Docker daemon (log rotation, etc.)
- name: Template Docker daemon.json
  ansible.builtin.template:
    src: daemon.json.j2
    dest: /etc/docker/daemon.json
    mode: '0644'
  notify: restart docker

- name: Flush handlers to apply daemon.json before deploying containers
  ansible.builtin.meta: flush_handlers

# Install Python Docker library for docker_compose_v2 module
- name: Install Docker Python library (python3-docker from apt)
  ansible.builtin.apt:
    name: python3-docker
    state: present
    cache_valid_time: 3600
  when: install_docker_python | bool

# Portainer deployment
- name: Create Portainer directory
  ansible.builtin.file:
    path: "{{ portainer_data_dir }}"
    state: directory
    mode: '0755'
  when: install_portainer | bool

- name: Template Portainer compose file
  ansible.builtin.template:
    src: portainer-compose.yml.j2
    dest: "{{ portainer_data_dir }}/compose.yml"
    mode: '0644'
  when: install_portainer | bool

- name: Deploy Portainer
  community.docker.docker_compose_v2:
    project_src: "{{ portainer_data_dir }}"
    state: present
  when: install_portainer | bool

# Dockge deployment
- name: Create Dockge directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - "{{ dockge_install_dir }}"
    - "{{ dockge_stacks_dir }}"
  when: install_dockge | bool

- name: Template Dockge compose file
  ansible.builtin.template:
    src: dockge-compose.yml.j2
    dest: "{{ dockge_install_dir }}/compose.yml"
    mode: '0644'
  when: install_dockge | bool

- name: Deploy Dockge
  community.docker.docker_compose_v2:
    project_src: "{{ dockge_install_dir }}"
    state: present
  when: install_dockge | bool
