# Hardened localhost setup
# Follows Nextcloud server hardening guidelines

- name: Hardened Localhost Setup
  hosts: localhost
  connection: local
  become: true

  vars:
    # Users (robertdebock.users)
    # Define users_user_list in inventory. Example:
    # users_user_list:
    #   - name: admin
    #     group: admin
    #     groups: sudo,docker
    #     sudo_options: "ALL=(ALL) NOPASSWD: ALL"
    #     authorized_keys:
    #       - "ssh-ed25519 AAAAC3..."

    # Firewall (geerlingguy.firewall)
    firewall_allowed_tcp_ports:
      - "22"
      - "80"
      - "443"
      - "{{ portainer_http_port }}"
      - "{{ portainer_https_port }}"
    firewall_allowed_udp_ports: []
    firewall_flush_rules_and_chains: false
    firewall_log_dropped_packets: true

    # OS hardening (devsec.hardening.os_hardening)
    sysctl_overwrite:
      net.ipv4.ip_forward: 1
      net.ipv6.conf.all.forwarding: 1

    # SSH hardening (devsec.hardening.ssh_hardening)
    sftp_enabled: true
    ssh_server_ports: ['22']
    ssh_max_auth_retries: 3

    # Fail2ban (robertdebock.fail2ban)
    fail2ban_bantime: 3600
    fail2ban_findtime: 600
    fail2ban_maxretry: 5
    fail2ban_ignoreips: "127.0.0.1/8 ::1 {{ ansible_default_ipv4.network | default('') }}/24"
    fail2ban_jail_configuration:
      - option: enabled
        value: "true"
        section: sshd

    # ClamAV (geerlingguy.clamav)
    clamav_daemon_state: started
    clamav_daemon_enabled: true

    # Docker (local role wrapping geerlingguy.docker)
    docker_edition: 'ce'
    docker_packages_state: present
    docker_service_manage: true
    docker_service_state: started
    docker_service_enabled: true
    docker_install_compose_plugin: true
    docker_compose_package_state: present
    docker_users: []                        # Managed by robertdebock.users instead
    install_docker_python: true
    install_portainer: true
    portainer_http_port: 8000
    portainer_https_port: 9443
    portainer_data_dir: "/opt/portainer"
    install_dockge: false
    dockge_port: 5001
    dockge_install_dir: "/opt/dockge"
    dockge_stacks_dir: "/opt/stacks"

    # Disk resize (local role)
    disk_device: "/dev/sda"
    partition_number: 1
    disk_resize_reboot: false

    # Hostname (local role)
    vm_hostname: "debian-vm"

    # Network (local role)
    network_interface: "eth0"
    static_ip: ""
    gateway_ip: ""
    dns_servers: []

  roles:
    # Phase 1: User setup (must happen before SSH hardening checks)
    - role: robertdebock.users
      vars:
        users: "{{ users_user_list }}"
        users_groups: "{{ users_group_list | default([]) }}"
      when: users_user_list | default([]) | length > 0

    # Phase 2: SSH lockout prevention check
    - role: ssh_preflight

    # Phase 3: Base system configuration
    - role: disk_resize
      when: resize_disk | default(false)

    - role: guest_agent

    - role: hostname
      when: change_hostname | default(false)

    # Phase 4: Docker installation (before firewall)
    - role: docker

    # Phase 5: Security hardening
    - role: devsec.hardening.os_hardening

    - role: devsec.hardening.ssh_hardening

    - role: geerlingguy.firewall

    - role: robertdebock.fail2ban

    - role: geerlingguy.clamav

    - role: robertdebock.cron

    # Phase 6: Network configuration (after firewall)
    - role: network
      when: configure_static_ip | default(false)
